<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blocked Users - Cloud Security Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background-color: #1e1e1e;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 20px;
            color: #e0e0e0;
            font-size: 1.3rem;
        }

        .card-body {
            color: #e0e0e0;
        }

        /* Navigation */
        .nav-pills .nav-link {
            color: #e0e0e0;
            border-radius: 8px;
            padding: 10px 20px;
            margin: 0 5px;
            transition: all 0.3s;
        }

        .nav-pills .nav-link.active {
            background-color: #1976d2;
        }

        .nav-pills .nav-link:hover:not(.active) {
            background-color: #2c2c2c;
        }

        /* Stats Cards */
        .stats-card {
            text-align: center;
            padding: 20px;
            background: #2c2c2c;
            color: #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stats-card:hover {
            transform: scale(1.05);
            background: #383838;
        }

        .stats-card h2 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #64b5f6;
            text-shadow: 0px 0px 5px rgba(100, 181, 246, 0.3);
        }

        .stats-card.danger h2 {
            color: #e57373;
            text-shadow: 0px 0px 5px rgba(229, 115, 115, 0.3);
        }

        .stats-card.warning h2 {
            color: #ffb74d;
            text-shadow: 0px 0px 5px rgba(255, 183, 77, 0.3);
        }

        .stats-card.success h2 {
            color: #81c784;
            text-shadow: 0px 0px 5px rgba(129, 199, 132, 0.3);
        }

        .stats-card h5 {
            color: #bdbdbd;
            margin-bottom: 0;
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Table */
        .table-responsive {
            margin-top: 5px;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background-color: #424242;
            border-radius: 4px;
        }

        .table {
            margin-bottom: 0;
            border-collapse: separate;
            border-spacing: 0;
            color: #e0e0e0;
            width: 100%;
        }
        
        /* Row hover effect for clickable rows */
        .user-row {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-row:hover {
            background-color: #2c2c2c !important;
            box-shadow: 0 2px 8px rgba(100, 181, 246, 0.2);
        }
        
        .user-row:hover td {
            background-color: #2c2c2c !important;
        }
        /* Checkbox styling */
input[type="checkbox"].activity-checkbox {
  width: 16px;
  height: 16px;
  accent-color: #64b5f6;
  margin: 0;
}

/* Activity badge container with checkbox */
.activity-badge {
  user-select: none;
}

/* Highlight selected activities */
input[type="checkbox"].activity-checkbox:checked + .activity-badge {
  box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.5);
}

        .table th {
            background-color: #2c2c2c;
            font-weight: 600;
            border-top: none;
            border-bottom: 2px solid #424242;
            padding: 14px 15px;
            color: #64b5f6;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 14px 15px;
            vertical-align: middle;
            border-bottom: 1px solid #333333;
            transition: background-color 0.2s;
            background-color: #1e1e1e;
        }

        .table tr:hover td {
            background-color: #282828;
        }

        /* Badges */
        .activity-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
            min-width: 120px;
            text-align: center;
        }

        .activity-badge.unshared {
            background-color: #d32f2f;
            color: white;
        }

        .activity-badge.download {
            background-color: #ffa000;
            color: black;
        }

        .activity-badge.delete {
            background-color: #e57373;
            color: white;
        }

        .activity-badge.sensitive {
            background-color: #7b68ee;
            color: white;
        }

        .activity-badge.success {
            background-color: #81c784;
            color: white;
        }

        /* Buttons */
        .btn-unblock {
            background-color: #388e3c;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-unblock:hover {
            background-color: #2e7d32;
            transform: scale(1.05);
        }

        .btn-unblock:disabled {
            background-color: #616161;
            cursor: not-allowed;
        }

        /* Filters */
        .filter-container {
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-select {
            background-color: #1e1e1e;
            border: 1px solid #424242;
            color: #e0e0e0;
            border-radius: 6px;
        }

        .form-select:focus {
            background-color: #1e1e1e;
            border-color: #64b5f6;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.25rem rgba(100, 181, 246, 0.25);
        }

        /* Refresh Button */
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #64b5f6;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            color: white;
            font-weight: 600;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
            background-color: #5fa8e6;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9e9e9e;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #616161;
        }

        .empty-state h4 {
            margin-bottom: 10px;
            color: #bdbdbd;
        }

        h1 {
            color: #64b5f6;
            font-weight: 700;
            letter-spacing: -0.5px;
            padding-bottom: 10px;
            position: relative;
            text-align: center;
        }

        h1:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background-color: #64b5f6;
            border-radius: 3px;
        }

        /* Activity Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #424242;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-header .user-email {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            line-height: 1;
        }

        .close:hover {
            transform: scale(1.1);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 10px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        .activity-item {
            background: #2c2c2c;
            border-left: 4px solid #64b5f6;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .activity-item:hover {
            background: #333333;
            box-shadow: 0 4px 12px rgba(100, 181, 246, 0.2);
            transform: translateX(5px);
        }

        .activity-item.unshared {
            border-left-color: #d32f2f;
        }

        .activity-item.download {
            border-left-color: #ffa000;
        }

        .activity-item.delete {
            border-left-color: #e57373;
        }

        .activity-item.sensitive {
            border-left-color: #7b68ee;
        }

        .activity-item.success {
            border-left-color: #81c784;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .activity-type-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity-type-badge.unshared {
            background-color: #d32f2f;
            color: white;
        }

        .activity-type-badge.download {
            background-color: #ffa000;
            color: black;
        }

        .activity-type-badge.delete {
            background-color: #e57373;
            color: white;
        }

        .activity-type-badge.sensitive {
            background-color: #7b68ee;
            color: white;
        }

        .activity-type-badge.success {
            background-color: #81c784;
            color: white;
        }

        .activity-timestamp {
            color: #9e9e9e;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .activity-details {
            color: #bdbdbd;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .activity-details-item {
            margin: 8px 0;
            display: flex;
            gap: 10px;
        }

        .activity-details-label {
            color: #64b5f6;
            font-weight: 600;
            min-width: 100px;
        }

        .activity-details-value {
            color: #e0e0e0;
            word-break: break-all;
        }

        .no-activities {
            text-align: center;
            padding: 60px 20px;
            color: #9e9e9e;
        }

        .no-activities i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #616161;
        }

        .activity-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .activity-stat-card {
            flex: 1;
            min-width: 150px;
            background: #2c2c2c;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .activity-stat-card h3 {
            font-size: 1.8rem;
            margin: 0;
            color: #64b5f6;
        }

        .activity-stat-card p {
            margin: 5px 0 0 0;
            color: #9e9e9e;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Navigation -->
        <ul class="nav nav-pills mb-4">
            <li class="nav-item">
                <a class="nav-link" href="/">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/file-based">File Based</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/user-based">User Based</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/sensitive_files">Sensitive Files</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/blocked-users">Blocked Users</a>
            </li>
        </ul>

        <h1 class="mb-4">Blocked Users Management</h1>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card danger">
                    <h2 id="totalBlocked">0</h2>
                    <h5>Total Blocked Users</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card warning">
                    <h2 id="blockedUnshared">0</h2>
                    <h5>Unauthorized Access</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card danger">
                    <h2 id="blockedDownload">0</h2>
                    <h5>Suspicious Downloads</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card danger">
                    <h2 id="blockedDelete">0</h2>
                    <h5>Suspicious Deletions</h5>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-container">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Filter by Activity Type</label>
                    <select class="form-select" id="activityFilter">
                        <option value="all">All Activities</option>
                        <option value="unsharedAccess">Unauthorized Access</option>
                        <option value="downloadCount">Suspicious Downloads</option>
                        <option value="deleteCount">Suspicious Deletions</option>
                        <option value="sensitiveCount">Sensitive Changes</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label">Search User</label>
                    <input type="text" class="form-select" id="searchInput" placeholder="Search by email address..." />
                </div>
            </div>
        </div>

        <!-- Blocked Users Table -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    Blocked Users List
                    <span class="badge bg-danger" id="displayCount">0</span>
                </h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email Address</th>
                                <th>Activity Type</th>
                                <th>Block Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="blockedUsersTable">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none">
                    <i class="bx bx-shield-quarter"></i>
                    <h4>No Blocked Users</h4>
                    <p>No users have been blocked yet. Users will appear here when they trigger security alerts.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn refresh-btn" onclick="refreshData()">
        <i class="bx bx-refresh"></i> Refresh
    </button>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2><i class="bx bx-history"></i> Activity History</h2>
                    <div class="user-email" id="modalUserEmail"></div>
                </div>
                <span class="close" onclick="closeActivityModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Activity stats -->
                <div class="activity-stats" id="activityStats"></div>
                
                <!-- Activity list -->
                <div id="activityList">
                    <div class="no-activities">
                        <i class="bx bx-loader bx-spin"></i>
                        <h4>Loading activities...</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let blockedUsersData = {};
        let filteredUsers = [];

        // Activity type labels
        const activityLabels = {
            unsharedAccess: "Unauthorized Access",
            downloadCount: "Suspicious Downloads",
            deleteCount: "Suspicious Deletions",
            sensitiveCount: "Sensitive Changes",
        };

        // Activity type classes for badges
        const activityClasses = {
            unsharedAccess: "unshared",
            downloadCount: "download",
            deleteCount: "delete",
            sensitiveCount: "sensitive",
        };

        // Load blocked users data
        function refreshData() {
            fetch("/api/blocked-users")
                .then((response) => response.json())
                .then((data) => {
                    blockedUsersData = data;
                    updateDashboard();
                    applyFilters();
                })
                .catch((error) => {
                    console.error("Error fetching blocked users:", error);
                });
        }

        // Update dashboard statistics
        function updateDashboard() {
            const stats = {
                total: new Set(),
                unsharedAccess: 0,
                downloadCount: 0,
                deleteCount: 0,
                sensitiveCount: 0,
            };

            // Count unique users across all activity types
            Object.keys(blockedUsersData).forEach((activityType) => {
                const users = blockedUsersData[activityType] || [];
                users.forEach((email) => {
                    stats.total.add(email);
                });
                stats[activityType] = users.length;
            });

            document.getElementById("totalBlocked").textContent = stats.total.size;
            document.getElementById("blockedUnshared").textContent =
                stats.unsharedAccess;
            document.getElementById("blockedDownload").textContent =
                stats.downloadCount;
            document.getElementById("blockedDelete").textContent =
                stats.deleteCount;
        }

        // Apply filters
        function applyFilters() {
            const activityFilter = document.getElementById("activityFilter").value;
            const searchTerm = document
                .getElementById("searchInput")
                .value.toLowerCase();

            filteredUsers = [];

            // Build list of users with their activities
            const userActivities = {};

            Object.keys(blockedUsersData).forEach((activityType) => {
                const users = blockedUsersData[activityType] || [];
                users.forEach((email) => {
                    if (!userActivities[email]) {
                        userActivities[email] = [];
                    }
                    userActivities[email].push(activityType);
                });
            });

            // Filter based on selected activity type and search term
            Object.keys(userActivities).forEach((email) => {
                const activities = userActivities[email];

                // Check if matches activity filter
                const matchesActivity =
                    activityFilter === "all" || activities.includes(activityFilter);

                // Check if matches search term
                const matchesSearch = email.toLowerCase().includes(searchTerm);

                if (matchesActivity && matchesSearch) {
                    filteredUsers.push({
                        email: email,
                        activities: activities,
                    });
                }
            });

            // Sort alphabetically
            filteredUsers.sort((a, b) => a.email.localeCompare(b.email));

            updateTable();
        }

        // Update table with filtered users
        // Update the updateTable function to add checkboxes for each activity
function updateTable() {
  const tbody = document.getElementById("blockedUsersTable");
  const emptyState = document.getElementById("emptyState");
  const displayCount = document.getElementById("displayCount");

  tbody.innerHTML = "";

  if (filteredUsers.length === 0) {
    tbody.style.display = "none";
    emptyState.style.display = "block";
    displayCount.textContent = "0";
    return;
  }

  tbody.style.display = "table-row-group";
  emptyState.style.display = "none";
  displayCount.textContent = filteredUsers.length;

  filteredUsers.forEach((user) => {
    const tr = document.createElement("tr");
    tr.className = "user-row";
    
    // Add click handler to open activity modal
    tr.addEventListener("click", function(e) {
      // Don't open modal if clicking on checkbox or button
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        return;
      }
      openActivityModal(user.email);
    });

    // Create activity badges with checkboxes
    const activityCheckboxes = user.activities
      .map((activity) => {
        const label = activityLabels[activity] || activity;
        const className = activityClasses[activity] || "secondary";
        return `
          <div style="display: inline-block; margin: 2px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
              <input 
                type="checkbox" 
                class="activity-checkbox" 
                data-email="${user.email}"
                data-activity="${activity}"
                checked
                style="cursor: pointer;"
                onclick="event.stopPropagation()"
              />
              <span class="activity-badge ${className}">${label}</span>
            </label>
          </div>
        `;
      })
      .join("");

    // Create block reason text
    const reasons = user.activities.map((activity) => {
      if (activity === "unsharedAccess")
        return "Attempted to access files without permission";
      if (activity === "downloadCount")
        return "Suspicious download pattern detected";
      if (activity === "deleteCount")
        return "Suspicious deletion pattern detected";
      if (activity === "sensitiveCount")
        return "Suspicious sensitive file changes";
      return "Security violation";
    });

    tr.innerHTML = `
      <td><strong>${user.email}</strong></td>
      <td>${activityCheckboxes}</td>
      <td>
        <ul style="margin: 0; padding-left: 20px;">
          ${reasons.map((r) => `<li>${r}</li>`).join("")}
        </ul>
      </td>
      <td>
        <button class="btn-unblock" onclick="event.stopPropagation(); unblockUser('${user.email}')">
          <i class="bx bx-lock-open"></i> Unblock Selected
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

// Updated unblock function - gets selected activities from checkboxes
function unblockUser(email) {
  // Get all checkboxes for this user
  const checkboxes = document.querySelectorAll(
    `input.activity-checkbox[data-email="${email}"]`
  );
  
  // Get only the checked activities
  const selectedActivities = Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.getAttribute('data-activity'));

  if (selectedActivities.length === 0) {
    alert('Please select at least one activity to unblock.');
    return;
  }

  // Build a readable list of activities
  const activityNames = selectedActivities.map(
    activity => activityLabels[activity] || activity
  );

  if (!confirm(
    `Are you sure you want to unblock ${email}?\n\n` +
    `This will reset their EWMA scores and allow them to access Google Drive again.\n\n` +
    `Selected activities to unblock:\n${activityNames.map(name => `‚Ä¢ ${name}`).join('\n')}`
  )) {
    return;
  }

  // Show loading state
  const button = event.target.closest('button');
  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="bx bx-loader bx-spin"></i> Unblocking...';

  // Send unblock request
  fetch('/api/unblock-user', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      email: email,
      activity_types: selectedActivities
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      // Show success message
      alert(
        `‚úÖ Successfully unblocked ${email}!\n\n` +
        `Unblocked activities:\n${activityNames.map(name => `‚Ä¢ ${name}`).join('\n')}\n\n` +
        `The user can now perform these activities normally.\n` +
        `Their EWMA scores have been reset.`
      );
      
      // Refresh the page to show updated data
      refreshData();
    } else {
      // Show error message
      alert(`‚ùå Failed to unblock ${email}\n\nError: ${data.message || 'Unknown error'}`);
      
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    }
  })
  .catch(error => {
    console.error('Error unblocking user:', error);
    alert(`‚ùå Failed to unblock ${email}\n\nError: ${error.message}`);
    
    // Restore button
    button.disabled = false;
    button.innerHTML = originalText;
  });
}

       
        // Event listeners
        document
            .getElementById("activityFilter")
            .addEventListener("change", applyFilters);
        document
            .getElementById("searchInput")
            .addEventListener("input", applyFilters);

        // Modal functions
        function openActivityModal(email) {
            const modal = document.getElementById('activityModal');
            const modalUserEmail = document.getElementById('modalUserEmail');
            const activityList = document.getElementById('activityList');
            const activityStats = document.getElementById('activityStats');
            
            // Set user email in modal
            modalUserEmail.textContent = email;
            
            // Show loading state
            activityList.innerHTML = `
                <div class="no-activities">
                    <i class="bx bx-loader bx-spin"></i>
                    <h4>Loading activities...</h4>
                </div>
            `;
            activityStats.innerHTML = '';
            
            // Show modal
            modal.style.display = 'block';
            
            // Fetch activities
            fetch(`/api/blocked-user-activities/${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayActivities(data.activities);
                    } else {
                        activityList.innerHTML = `
                            <div class="no-activities">
                                <i class="bx bx-error"></i>
                                <h4>Error Loading Activities</h4>
                                <p>${data.message || 'Unknown error'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching activities:', error);
                    activityList.innerHTML = `
                        <div class="no-activities">
                            <i class="bx bx-error"></i>
                            <h4>Error Loading Activities</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }

        function closeActivityModal() {
            const modal = document.getElementById('activityModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('activityModal');
            if (event.target === modal) {
                closeActivityModal();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeActivityModal();
            }
        });

        function displayActivities(activities) {
            const activityList = document.getElementById('activityList');
            const activityStats = document.getElementById('activityStats');
            
            if (!activities || activities.length === 0) {
                activityList.innerHTML = `
                    <div class="no-activities">
                        <i class="bx bx-check-shield"></i>
                        <h4>No Activities Recorded</h4>
                        <p>This user has not attempted any activities since being blocked.</p>
                    </div>
                `;
                activityStats.innerHTML = '';
                return;
            }

            // Calculate statistics
            const stats = {
                total: activities.length,
                unsharedAccess: activities.filter(a => a.activity_type === 'unsharedAccess').length,
                downloadCount: activities.filter(a => a.activity_type === 'downloadCount').length,
                deleteCount: activities.filter(a => a.activity_type === 'deleteCount').length,
                sensitiveCount: activities.filter(a => a.activity_type === 'sensitiveCount').length,
                blocked: activities.filter(a => a.details?.status === 'blocked').length,
                allowed: activities.filter(a => a.details?.status === 'allowed').length
            };

            // Display stats
            activityStats.innerHTML = `
                <div class="activity-stat-card">
                    <h3>${stats.total}</h3>
                    <p>Total Attempts</p>
                </div>
                <div class="activity-stat-card">
                    <h3 style="color: #d32f2f;">${stats.blocked}</h3>
                    <p>Blocked</p>
                </div>
                <div class="activity-stat-card">
                    <h3 style="color: #81c784;">${stats.allowed}</h3>
                    <p>Allowed</p>
                </div>
                ${stats.unsharedAccess > 0 ? `
                <div class="activity-stat-card">
                    <h3 style="color: #d32f2f;">${stats.unsharedAccess}</h3>
                    <p>Unauthorized Access</p>
                </div>
                ` : ''}
                ${stats.downloadCount > 0 ? `
                <div class="activity-stat-card">
                    <h3 style="color: #ffa000;">${stats.downloadCount}</h3>
                    <p>Download Attempts</p>
                </div>
                ` : ''}
                ${stats.deleteCount > 0 ? `
                <div class="activity-stat-card">
                    <h3 style="color: #e57373;">${stats.deleteCount}</h3>
                    <p>Delete Attempts</p>
                </div>
                ` : ''}
                ${stats.sensitiveCount > 0 ? `
                <div class="activity-stat-card">
                    <h3 style="color: #7b68ee;">${stats.sensitiveCount}</h3>
                    <p>Sensitive File Access</p>
                </div>
                ` : ''}
            `;

            // Display activities
            activityList.innerHTML = activities.map(activity => {
                const activityClass = activityClasses[activity.activity_type] || 'secondary';
                const activityLabel = activityLabels[activity.activity_type] || activity.activity_type;
                const timestamp = new Date(activity.timestamp).toLocaleString();
                const status = activity.details?.status || 'unknown';
                
                // Status badge
                const statusBadge = status === 'blocked' 
                    ? '<span style="background: #d32f2f; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: 10px;">üö´ BLOCKED</span>'
                    : '<span style="background: #388e3c; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin-left: 10px;">‚úÖ ALLOWED</span>';
                
                // Format details
                let detailsHtml = '';
                if (activity.details) {
                    if (activity.details.url) {
                        const shortUrl = activity.details.url.length > 80 
                            ? activity.details.url.substring(0, 80) + '...' 
                            : activity.details.url;
                        detailsHtml += `
                            <div class="activity-details-item">
                                <span class="activity-details-label">URL:</span>
                                <span class="activity-details-value" title="${activity.details.url}">${shortUrl}</span>
                            </div>
                        `;
                    }
                    if (activity.details.method) {
                        detailsHtml += `
                            <div class="activity-details-item">
                                <span class="activity-details-label">Method:</span>
                                <span class="activity-details-value">${activity.details.method}</span>
                            </div>
                        `;
                    }
                    if (activity.details.risk_level) {
                        detailsHtml += `
                            <div class="activity-details-item">
                                <span class="activity-details-label">Risk Level:</span>
                                <span class="activity-details-value" style="color: ${activity.details.risk_level === 'critical' ? '#d32f2f' : '#ffa000'}; font-weight: 600; text-transform: uppercase;">${activity.details.risk_level}</span>
                            </div>
                        `;
                    }
                    if (activity.details.reason) {
                        detailsHtml += `
                            <div class="activity-details-item">
                                <span class="activity-details-label">Reason:</span>
                                <span class="activity-details-value">${activity.details.reason.replace(/_/g, ' ')}</span>
                            </div>
                        `;
                    }
                    if (activity.details.block_point) {
                        detailsHtml += `
                            <div class="activity-details-item">
                                <span class="activity-details-label">Block Point:</span>
                                <span class="activity-details-value" style="font-family: monospace; font-size: 0.85em;">${activity.details.block_point}</span>
                            </div>
                        `;
                    }
                }
                
                if (activity.file_id) {
                    detailsHtml += `
                        <div class="activity-details-item">
                            <span class="activity-details-label">File ID:</span>
                            <span class="activity-details-value">${activity.file_id}</span>
                        </div>
                    `;
                }

                return `
                    <div class="activity-item ${activityClass}">
                        <div class="activity-header">
                            <div>
                                <span class="activity-type-badge ${activityClass}">${activityLabel}</span>
                                ${statusBadge}
                            </div>
                            <span class="activity-timestamp">
                                <i class="bx bx-time"></i>
                                ${timestamp}
                            </span>
                        </div>
                        <div class="activity-details">
                            ${detailsHtml || '<p style="color: #9e9e9e;">No additional details available</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initial load
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>

</html>