<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sensitive Files - Cloud Security Monitor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .container-fluid {
        padding: 20px;
      }
      .card {
        background-color: #1e1e1e;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: none;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
      }
      .card-title {
        font-weight: 600;
        margin-bottom: 20px;
        color: #e0e0e0;
        font-size: 1.3rem;
      }
      .card-body {
        color: #e0e0e0;
      }
      .stats-card {
        text-align: center;
        padding: 20px;
        background: #2c2c2c;
        color: #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .stats-card:hover {
        transform: scale(1.05);
        background: #383838;
      }
      .stats-card h2 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #64b5f6;
        text-shadow: 0px 0px 5px rgba(100, 181, 246, 0.3);
      }
      .stats-card h5 {
        color: #bdbdbd;
        margin-bottom: 0;
        font-weight: 500;
        font-size: 0.95rem;
      }
      .table-responsive {
        margin-top: 5px;
        max-height: calc(100vh - 350px);
        overflow-y: auto;
      }
      .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }
      .table-responsive::-webkit-scrollbar-track {
        background: #1e1e1e;
        border-radius: 4px;
      }
      .table-responsive::-webkit-scrollbar-thumb {
        background-color: #424242;
        border-radius: 4px;
      }
      .table {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
        color: #e0e0e0;
        width: 100%;
      }
      .table th {
        background-color: #2c2c2c;
        font-weight: 600;
        border-top: none;
        border-bottom: 2px solid #424242;
        padding: 14px 15px;
        color: #64b5f6;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }
      .table td {
        padding: 14px 15px;
        vertical-align: middle;
        border-bottom: 1px solid #333333;
        transition: background-color 0.2s;
        background-color: #1e1e1e;
      }
      .table tr:hover td {
        background-color: #282828;
      }
      .risk-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }
      .risk-CRITICAL {
        background-color: #dc3545;
        color: white;
      }
      .risk-HIGH {
        background-color: #ffc107;
        color: black;
      }
      .risk-MODERATE {
        background-color: #0dcaf0;
        color: black;
      }
      .risk-LOW {
        background-color: #198754;
        color: white;
      }
      .risk-NONE {
        background-color: #6c757d;
        color: white;
      }

      .sensitivity-chart {
        height: 8px;
        border-radius: 4px;
        margin: 5px 0;
        background: #2c2c2c;
        overflow: hidden;
      }

      .sensitivity-bar {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(
          90deg,
          #198754 0%,
          #ffc107 50%,
          #dc3545 100%
        );
      }

      .form-select,
      .form-control {
        background-color: #2c2c2c;
        border: 1px solid #424242;
        color: #e0e0e0;
      }
      .form-select:focus,
      .form-control:focus {
        background-color: #2c2c2c;
        border-color: #64b5f6;
        color: #e0e0e0;
        box-shadow: 0 0 0 0.25rem rgba(100, 181, 246, 0.25);
      }

      .modal-content {
        background-color: #1e1e1e;
        color: #e0e0e0;
      }
      .modal-header {
        border-bottom: 1px solid #424242;
      }
      .modal-footer {
        border-top: 1px solid #424242;
      }
      .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
      }

      .progress {
        background-color: #2c2c2c;
      }

      .nav-tabs {
        border-bottom: 1px solid #424242;
      }
      .nav-tabs .nav-link {
        color: #e0e0e0;
        border: none;
        border-bottom: 2px solid transparent;
      }
      .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #64b5f6;
      }
      .nav-tabs .nav-link.active {
        background-color: transparent;
        border-color: #64b5f6;
        color: #64b5f6;
      }

      /* Navigation */
      .nav-pills .nav-link {
        color: #e0e0e0;
        border-radius: 8px;
        padding: 10px 20px;
        margin: 0 5px;
        transition: all 0.3s;
      }
      .nav-pills .nav-link.active {
        background-color: #1976d2;
      }
      .nav-pills .nav-link:hover:not(.active) {
        background-color: #2c2c2c;
      }


      .score-change {
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
      }

      .score-increase {
        color: #198754;
        background-color: rgba(25, 135, 84, 0.1);
      }

      .score-decrease {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
      }

      .score-no-change {
        color: #6c757d;
        font-size: 0.9em;
      }

      .previous-score {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 2px;
      }

      .entities-breakdown {
        display: flex;
        gap: 5px;
        justify-content: center;
      }

      .entity-count {
        font-size: 0.85em;
        padding: 2px 6px;
        border-radius: 4px;
        min-width: 24px;
        text-align: center;
      }

      .entity-count.high {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
      }

      .entity-count.moderate {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      .entity-count.low {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
      }

      .no-entities {
        color: #6c757d;
        font-size: 0.9em;
        font-style: italic;
      }

      .total-entities {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 4px;
        text-align: center;
      }

      .alert {
        background-color: #1e1e1e;
        border: 1px solid #424242;
        color: #e0e0e0;
      }

      .alert-info {
        border-left: 4px solid #0dcaf0;
      }

      .table-responsive {
        max-height: 400px;
        overflow-y: auto;
      }

      .table th {
        position: sticky;
        top: 0;
        background-color: #1a1a1a;
        z-index: 1;
      }

      /* Hide unwanted summary cards */
      #totalEntitiesCard,
      #avgRiskScoreCard,
      #totalEntities,
      #avgRiskScore {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <ul class="nav nav-pills mb-4">
        <li class="nav-item">
          <a class="nav-link" href="/">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/user-based">User Based</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/file-based">File Based</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/sensitive_files">Sensitive Files</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blocked-users">Blocked Users</a>
        </li>
      </ul>

      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card">
            <h2 id="totalFiles">0</h2>
            <h5>Total Scanned Files</h5>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <h2 id="highRiskFiles">0</h2>
            <h5>High Risk Files</h5>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <h2 id="totalEntities">0</h2>
            <h5>Total Entities Found</h5>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <h2 id="avgRiskScore">0</h2>
            <h5>Average Risk Score</h5>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Risk Level</label>
              <select class="form-select" id="riskFilter">
                <option value="">All</option>
                <option value="CRITICAL">Critical</option>
                <option value="HIGH">High</option>
                <option value="MODERATE">Moderate</option>
                <option value="LOW">Low</option>
                <option value="NONE">None</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Owner</label>
              <select class="form-select" id="ownerFilter">
                <option value="">All</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Search Files</label>
              <input
                type="text"
                class="form-control"
                id="searchInput"
                placeholder="Search by filename..."
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Sensitive Files Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>File Name</th>
                  <th>Risk Level</th>
                  <th>Sensitivity Score</th>
                  <th>Score Change</th>
                  <th>Modified By</th>
                  <th>Owner</th>
                  <th>Entities</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="sensitiveFilesTable">
                <!-- Table rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

   

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">File Scan Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="modalBody">
            <!-- Details will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let sensitiveFiles = [];
      const modal = new bootstrap.Modal(
        document.getElementById("detailsModal")
      );

      function refreshData() {
        fetch("/api/sensitive_files")
          .then((response) => response.json())
          .then((data) => {
            sensitiveFiles = data;
            updateDashboard();
            updateTable();
          })
          .catch((error) => console.error("Error:", error));
      }

      function updateDashboard() {
        const stats = calculateStats();
        document.getElementById("totalFiles").textContent = stats.totalFiles;
        document.getElementById("highRiskFiles").textContent =
          stats.highRiskFiles;

        // Hide the cards we no longer want to show (in case they are still in the DOM)
        const entCard = document
          .getElementById("totalEntities")
          ?.closest(".col-md-3");
        if (entCard) entCard.style.display = "none";
        const avgCard = document
          .getElementById("avgRiskScore")
          ?.closest(".col-md-3");
        if (avgCard) avgCard.style.display = "none";

        // Update owner filter options
        const owners = [...new Set(sensitiveFiles.map((file) => file.owner))];
        const ownerFilter = document.getElementById("ownerFilter");
        ownerFilter.innerHTML =
          '<option value="">All</option>' +
          owners
            .map((owner) => `<option value="${owner}">${owner}</option>`)
            .join("");
      }

      function calculateStats() {
        // Count unique files by ID
        const uniqueIds = new Set();
        const highRiskIds = new Set();

        sensitiveFiles.forEach((f) => {
          uniqueIds.add(f.file_id);
          const risk = f.details.changes[0].risk_level;
          if (risk === "HIGH" || risk === "CRITICAL") {
            highRiskIds.add(f.file_id);
          }
        });

        return {
          totalFiles: uniqueIds.size,
          highRiskFiles: highRiskIds.size,
        };
      }

      function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
      }

      function updateTable() {
        const riskLevel = document.getElementById("riskFilter").value;
        const owner = document.getElementById("ownerFilter").value;
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();

        // Group files by FileID to track changes
        const fileGroups = {};
        sensitiveFiles.forEach((file) => {
          if (!fileGroups[file.file_id]) {
            fileGroups[file.file_id] = [];
          }
          fileGroups[file.file_id].push(file);
        });

        // Sort each group by timestamp (newest first)
        Object.values(fileGroups).forEach((group) => {
          group.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        });

        // Get the latest version of each file
        const latestFiles = Object.values(fileGroups).map((group) => group[0]);

        const filteredFiles = latestFiles.filter((file) => {
          const changes = file.details.changes[0];
          const riskLevelFromLog =
            file.risk_level || changes.risk_level || "NONE";
          return (
            (!riskLevel || riskLevelFromLog === riskLevel) &&
            (!owner || file.owner === owner) &&
            (!search || file.details.file_name.toLowerCase().includes(search))
          );
        });

        // Sort filtered files by timestamp (newest first)
        filteredFiles.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        const tbody = document.getElementById("sensitiveFilesTable");
        tbody.innerHTML = filteredFiles
          .map((file) => {
            const changes = file.details.changes[0];

            // Parse all numeric values
            const score = parseInt(changes.score || "0");
            const highSensitivity = parseInt(
              file.high_sensitivity || changes.high_sensitivity || "0"
            );
            const moderateSensitivity = parseInt(
              file.moderate_sensitivity || changes.moderate_sensitivity || "0"
            );
            const lowSensitivity = parseInt(
              file.low_sensitivity || changes.low_sensitivity || "0"
            );
            const totalEntities = parseInt(
              file.total_entities || changes.total_entities || "0"
            );
            const riskLevelFromLog =
              file.risk_level || changes.risk_level || "NONE";

            // Handle score changes
            const scoreChange = parseInt(changes.score_change || "0");
            const previousScore = changes.previous_score
              ? parseInt(changes.previous_score)
              : null;

            const scoreChangeHtml =
              scoreChange !== 0
                ? `<span class="score-change ${
                    scoreChange > 0 ? "score-increase" : "score-decrease"
                  }">
                    ${scoreChange > 0 ? "+" : ""}${scoreChange}
                </span>
                ${
                  previousScore !== null
                    ? `<div class="previous-score">Previous: ${previousScore}/100</div>`
                    : ""
                }`
                : '<span class="score-no-change">No change</span>';

            return `
                <tr>
                    <td>${formatTimestamp(file.timestamp)}</td>
                    <td>${file.details.file_name}</td>
                    <td>
                        <span class="risk-badge risk-${riskLevelFromLog}">
                            ${riskLevelFromLog}
                        </span>
                    </td>
                    <td>
                        <div class="sensitivity-chart">
                            <div class="sensitivity-bar" style="width: ${score}%"></div>
                        </div>
                        ${score}/100
                    </td>
                    <td class="text-center">
                        ${scoreChangeHtml}
                    </td>
                    <td>${file.details.modified_by || "N/A"}</td>
                    <td>${file.owner}</td>
                    <td>
                        <div class="entities-breakdown">
                            ${
                              totalEntities > 0
                                ? `
                                ${
                                  highSensitivity > 0
                                    ? `<span class="entity-count high" title="High Sensitivity">${highSensitivity}</span>`
                                    : ""
                                }
                                ${
                                  moderateSensitivity > 0
                                    ? `<span class="entity-count moderate" title="Moderate Sensitivity">${moderateSensitivity}</span>`
                                    : ""
                                }
                                ${
                                  lowSensitivity > 0
                                    ? `<span class="entity-count low" title="Low Sensitivity">${lowSensitivity}</span>`
                                    : ""
                                }
                                <div class="total-entities">Total: ${totalEntities}</div>
                            `
                                : '<span class="no-entities">No entities found</span>'
                            }
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="showFileHistory('${
                          file.file_id
                        }')">
                            View History
                        </button>
                    </td>
                </tr>
            `;
          })
          .join("");
      }

      function showFileHistory(fileId) {
        const fileScans = sensitiveFiles.filter((f) => f.file_id === fileId);
        if (!fileScans.length) return;

        // Sort scans by timestamp (newest first)
        fileScans.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        const latestScan = fileScans[0];

        document.getElementById("modalBody").innerHTML = `
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-info mb-3">File Information</h6>
                        <p><strong>Name:</strong> ${
                          latestScan.details.file_name
                        }</p>
                        <p><strong>Owner:</strong> ${latestScan.owner}</p>
                        <p><strong>Last Modified By:</strong> ${
                          latestScan.details.modified_by || "N/A"
                        }</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="text-info mb-3">Scan History</h6>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Score</th>
                                        <th>Risk Level</th>
                                        <th>Entities (H/M/L)</th>
                                        <th>Modified By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fileScans
                                      .map((scan) => {
                                        const changes = scan.details.changes[0];
                                        const score = parseInt(
                                          changes.score || "0"
                                        );
                                        const high = parseInt(
                                          scan.high_sensitivity ||
                                            changes.high_sensitivity ||
                                            "0"
                                        );
                                        const moderate = parseInt(
                                          scan.moderate_sensitivity ||
                                            changes.moderate_sensitivity ||
                                            "0"
                                        );
                                        const low = parseInt(
                                          scan.low_sensitivity ||
                                            changes.low_sensitivity ||
                                            "0"
                                        );
                                        const total = parseInt(
                                          scan.total_entities ||
                                            changes.total_entities ||
                                            "0"
                                        );
                                        const riskLevelFromLog =
                                          scan.risk_level ||
                                          changes.risk_level ||
                                          "NONE";

                                        return `
                                            <tr>
                                                <td>${formatTimestamp(
                                                  scan.timestamp
                                                )}</td>
                                                <td>${score}/100</td>
                                                <td>
                                                    <span class="risk-badge risk-${riskLevelFromLog}">
                                                        ${riskLevelFromLog}
                                                    </span>
                                                </td>
                                                <td>${
                                                  total > 0
                                                    ? `${high}/${moderate}/${low}`
                                                    : "None"
                                                }</td>
                                                <td>${
                                                  scan.details.modified_by ||
                                                  "N/A"
                                                }</td>
                                            </tr>
                                        `;
                                      })
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        modal.show();
      }

      // Event listeners for filters
      document
        .getElementById("riskFilter")
        .addEventListener("change", updateTable);
      document
        .getElementById("ownerFilter")
        .addEventListener("change", updateTable);
      document
        .getElementById("searchInput")
        .addEventListener("input", updateTable);

      // Initial load
      refreshData();

      // Auto-refresh every 30 seconds
      setInterval(refreshData, 30000);
    </script>
  </body>
</html>
